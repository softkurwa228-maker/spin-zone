import telebot
from telebot import types
import sqlite3
import random
import datetime
import time

TOKEN = "–í–°–¢–ê–í–¨_–°–í–û–ô_–¢–û–ö–ï–ù"
bot = telebot.TeleBot(TOKEN)

conn = sqlite3.connect("spinzone.db", check_same_thread=False)
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS users(
    user_id INTEGER PRIMARY KEY,
    coins INTEGER,
    xp INTEGER,
    ref_by INTEGER,
    last_bonus TEXT,
    last_spin REAL,
    spins INTEGER
)
""")
conn.commit()


# ================= DATABASE =================

def get_user(user_id):
    cursor.execute("SELECT * FROM users WHERE user_id=?", (user_id,))
    return cursor.fetchone()


def create_user(user_id, ref=None):
    cursor.execute(
        "INSERT INTO users VALUES (?, ?, ?, ?, ?, ?, ?)",
        (user_id, 1000, 0, ref, "", 0, 0)
    )
    conn.commit()


def update_user(user_id, coins=None, xp=None, last_bonus=None, last_spin=None, spins=None):
    user = get_user(user_id)

    coins = coins if coins is not None else user[1]
    xp = xp if xp is not None else user[2]
    last_bonus = last_bonus if last_bonus is not None else user[4]
    last_spin = last_spin if last_spin is not None else user[5]
    spins = spins if spins is not None else user[6]

    cursor.execute("""
        UPDATE users 
        SET coins=?, xp=?, last_bonus=?, last_spin=?, spins=? 
        WHERE user_id=?
    """, (coins, xp, last_bonus, last_spin, spins, user_id))
    conn.commit()


# ================= UI =================

def main_menu():
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("üé∞ –ò–≥—Ä–∞—Ç—å", callback_data="spin"),
        types.InlineKeyboardButton("üéÅ –ë–æ–Ω—É—Å", callback_data="bonus"),
        types.InlineKeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="profile"),
        types.InlineKeyboardButton("üèÜ –¢–æ–ø", callback_data="top"),
    )
    return markup


# ================= START =================

@bot.message_handler(commands=['start'])
def start(message):
    args = message.text.split()
    user = get_user(message.from_user.id)

    if not user:
        ref = None
        if len(args) > 1:
            try:
                ref = int(args[1])
                if ref == message.from_user.id:
                    ref = None
                elif not get_user(ref):
                    ref = None
            except:
                ref = None

        create_user(message.from_user.id, ref)

    bot.send_message(
        message.chat.id,
        "üé∞ <b>SPIN ZONE 2.0</b>\n\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        parse_mode="HTML",
        reply_markup=main_menu()
    )


# ================= SPIN =================

@bot.callback_query_handler(func=lambda call: call.data == "spin")
def spin(call):
    user = get_user(call.from_user.id)

    if not user:
        bot.answer_callback_query(call.id, "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ /start")
        return

    # –ö–î 2 —Å–µ–∫—É–Ω–¥—ã
    if time.time() - user[5] < 2:
        bot.answer_callback_query(call.id, "‚è≥ –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ")
        return

    if user[1] < 100:
        bot.answer_callback_query(call.id, "‚ùå –ù—É–∂–Ω–æ 100 –º–æ–Ω–µ—Ç")
        return

    bet = 100
    coins = user[1] - bet
    xp = user[2]
    spins = user[6] + 1

    symbols = ["üçí", "üçã", "üîî", "üíé", "7Ô∏è‚É£"]
    result = [random.choice(symbols) for _ in range(3)]

    win = 0

    # –≤—ã–ø–ª–∞—Ç—ã
    if result.count("7Ô∏è‚É£") == 3:
        win = bet * 20
    elif result.count("üíé") == 3:
        win = bet * 10
    elif result.count("üîî") == 3:
        win = bet * 5
    elif result.count("üçí") == 3:
        win = bet * 3
    elif len(set(result)) == 2:
        win = int(bet * 1.5)

    coins += win
    xp += 10 if win > 0 else 2

    update_user(call.from_user.id, coins, xp, last_spin=time.time(), spins=spins)

    text = f"üé∞ {' | '.join(result)}\n\n"

    if win > 0:
        text += f"üî• –¢—ã –≤—ã–∏–≥—Ä–∞–ª {win} –º–æ–Ω–µ—Ç!"
    else:
        text += "üò¢ –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª"

    bot.edit_message_text(
        text,
        call.message.chat.id,
        call.message.message_id,
        reply_markup=main_menu()
    )


# ================= BONUS =================

@bot.callback_query_handler(func=lambda call: call.data == "bonus")
def bonus(call):
    user = get_user(call.from_user.id)
    today = str(datetime.date.today())

    if user[4] == today:
        bot.answer_callback_query(call.id, "üéÅ –£–∂–µ –ø–æ–ª—É—á–∞–ª —Å–µ–≥–æ–¥–Ω—è")
        return

    reward = random.randint(200, 500)
    update_user(call.from_user.id,
                coins=user[1] + reward,
                last_bonus=today)

    bot.edit_message_text(
        f"üéÅ –¢—ã –ø–æ–ª—É—á–∏–ª {reward} –º–æ–Ω–µ—Ç!",
        call.message.chat.id,
        call.message.message_id,
        reply_markup=main_menu()
    )


# ================= PROFILE =================

@bot.callback_query_handler(func=lambda call: call.data == "profile")
def profile(call):
    user = get_user(call.from_user.id)

    level = "Bronze"
    if user[2] >= 300:
        level = "Diamond"
    elif user[2] >= 150:
        level = "Gold"
    elif user[2] >= 50:
        level = "Silver"

    text = (
        f"üë§ –ü—Ä–æ—Ñ–∏–ª—å\n\n"
        f"üí∞ –ú–æ–Ω–µ—Ç—ã: {user[1]}\n"
        f"‚≠ê XP: {user[2]}\n"
        f"üèÜ –£—Ä–æ–≤–µ–Ω—å: {level}\n"
        f"üé∞ –°–ø–∏–Ω–æ–≤: {user[6]}"
    )

    bot.edit_message_text(
        text,
        call.message.chat.id,
        call.message.message_id,
        reply_markup=main_menu()
    )


# ================= TOP =================

@bot.callback_query_handler(func=lambda call: call.data == "top")
def top(call):
    cursor.execute("SELECT user_id, coins FROM users ORDER BY coins DESC LIMIT 5")
    top_users = cursor.fetchall()

    text = "üèÜ –¢–û–ü 5 –∏–≥—Ä–æ–∫–æ–≤:\n\n"
    for i, u in enumerate(top_users):
        text += f"{i+1}. ID {u[0]} ‚Äî {u[1]} –º–æ–Ω–µ—Ç\n"

    bot.edit_message_text(
        text,
        call.message.chat.id,
        call.message.message_id,
        reply_markup=main_menu()
    )


print("SPIN ZONE 2.0 ONLINE üöÄ")
bot.infinity_polling()
